import{r as m,u as te,o as ae,a as l,b as k,d as t,e as P,F as w,f as h,g as u,m as se,w as C,l as ne,i as o,t as i,j as oe,n as le,p as re,T as de,k as ie,h as ce}from"./index-Co3AnUBe.js";import{c as E,d as _e,e as ue,f as me,_ as ve,a as ke,b as ye,v as pe,t as fe}from"./v-header-ZVBZbPrH.js";import{u as ge,_ as V,a as we,b as he,c as be}from"./v-modals-container-C6r9fi1w.js";import{d as De}from"./daypilot-vue.min-D_6ypU26.js";const $e={class:"wrapper"},Se={key:0,class:"v-calendar-week"},Me={class:"v-calendar-week__container container"},Te={key:0,class:"v-calendar-week__content scroll-container"},Ce={key:0,class:"v-calendar-week__table calendar"},Ee={class:"calendar-header"},Le={key:0,class:"calendar-row"},Ie=["onDrop"],xe={class:"calendar-row__item-content calendar-card"},We=["onClick","onDragstart"],Be={key:0,class:"calendar-card__break"},Oe={key:1,class:"v-calendar-week__break scroll-container"},Re=["onClick"],qe={class:"event-header"},ze={class:"calendar-card__content"},Fe={class:"calendar-card__lesson"},Ne={key:0,class:"calendar-card__break"},He={key:2,class:"loader-container"},Pe={key:1,class:"v-calendar-week-mob mob-page"},Ve={class:"v-calendar-week-mob__container container"},Ue={key:0,class:"v-calendar-week-mob__list"},je={key:0,class:"day"},Ge=["onClick"],Ae={class:"day__date"},Je={key:0},Ke={class:"day__lesson"},Qe={class:"day__lesson-time"},Xe={class:"day__lesson-name"},Ye={key:0,class:"day__lesson break"},Ze={class:"day__lesson-block"},et={class:"day__lesson-time"},tt=10,U=90,rt={__name:"v-calendar-week",setup(at){const{isMobile:j}=ge(),p=m({}),G=ie(),L=ne(),f=m(localStorage.getItem("breakMode")==="true"),$=m();m(new Date);const I=m(L.query.start_date||"01.12.2025"),x=m({viewType:"Week",startDate:E(I.value),allowEventOverlap:!1,eventResizeHandling:"Disabled",timeRangeSelectedHandling:"Disabled",locale:"ru-RU",headerDateFormat:"ddd, d",touch:!0,weekStarts:1,onEventMoved:a=>{console.log("Event moved",a);const e=a.newStart.value,d=a.newStart.value,r=new Date(e).getDay(),s={start_time:e,end_time:d,day_of_week:r-1},_=a.e.data.lesson_id;console.log(s,_)},onEventResized:a=>{console.log("Event resized")}}),A=async a=>{const e=[];if(a)for(let d in a.week.days)a.week.days[d].lessons.forEach(n=>{const{start_time:r,end_time:s,..._}=n,y=`${a.week.days[d].day} ${r}`.replace(/(\d{2})\.(\d{2})\.(\d{4})/,"$3-$2-$1T").replace(" ",""),T=`${a.week.days[d].day} ${s}`.replace(/(\d{2})\.(\d{2})\.(\d{4})/,"$3-$2-$1T").replace(" ","");e.push({start:y,end:T,start_time:s.slice(0,5),end_time:s.slice(0,5),..._})});console.log(e),$.value=e},S=m({0:{day_of_week:"пн",date:""},1:{day_of_week:"вт",date:""},2:{day_of_week:"ср",date:""},3:{day_of_week:"чт",date:""},4:{day_of_week:"пт",date:""},5:{day_of_week:"сб",date:""},6:{day_of_week:"вс",date:""}}),W=te("modalsContainer"),c=m(),B=m({}),M=m({lesson:null,fromColumnIndex:null,fromLessonIndex:null}),J=(a,e,d,n)=>{M.value={lesson:e,fromColumnIndex:d,fromLessonIndex:n}},O=a=>a.slice(0,5),K=(a,e)=>{const{lesson:d,fromColumnIndex:n,fromLessonIndex:r}=M.value;if(n!==e){const s=c.value.week.days[n].lessons,_=c.value.week.days[e].lessons,y=S.value[e].date.toISOString().split("T")[0],T={day_of_week_id:parseInt(e),start_time:d.start_time,end_time:d.end_time,conducted_date:y},g=v=>{const[D,H]=v.split(":").map(Number);return D*60+H},F=g(d.start_time),ee=g(d.end_time);for(let v of _){const D=g(v.start_time);if(!(g(v.end_time)<=F||D>=ee)){alert("В этот день уже есть занятие на данное время");return}}let N=_.length;for(let v=0;v<_.length;v++)if(g(_[v].start_time)>F){N=v;break}s.splice(r,1),_.splice(N,0,d),fe(d.lesson_id,T).then(()=>{console.log("Перенос осуществлен")})}M.value={lesson:null,fromColumnIndex:null,fromLessonIndex:null}},R=()=>{f.value=!f.value,localStorage.setItem("breakMode",f.value),b()},Q=()=>{b()},X=a=>{if(!(a in p.value)){p.value[a]=!0;return}p.value[a]=!p.value[a]},q=a=>{W.value.toggleLessonModals("buttons",a)},Y=a=>Math.max(U,U*a),z=a=>{G.push({query:{start_date:a}}).then(()=>{b()})},Z=a=>{const[e,d,n]=a.split(".").map(Number);let r=new Date(n,d-1,e);return r=r.getDay()||7,S.value[r-1].date=new Date(n,d-1,e),`${S.value[r-1].day_of_week}, ${e}`},b=()=>{const a=L.query;if("start_date"in a)I.value=E(a.start_date),x.value.startDate=E(a.start_date),_e(a.start_date).then(e=>{console.log("Загружаем"),A(e),B.value=e,c.value=e});else{const e=ue(new Date);window.location.search=`?start_date=${me(e)}`}console.log(B.value)};return ae(()=>{b()}),(a,e)=>{const d=ce("router-link");return o(),l("div",$e,[k(ve),t("main",null,[P(j)?(o(),l("section",Pe,[t("div",Ve,[k(V,{"is-showed-break":!0,type:"week",onSetWeek:z,onToggleBreakMode:R}),c.value&&c.value.week?(o(),l("ul",Ue,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("li",{key:r,class:"v-calendar-week-mob__list-item"},[n?(o(),l("div",je,[t("div",{class:"day__header",onClick:s=>X(r)},[t("p",Ae,i(n.day),1),e[2]||(e[2]=t("img",{src:ke,class:"day-el",alt:""},null,-1)),e[3]||(e[3]=t("img",{src:ye,class:"night-el",alt:""},null,-1))],8,Ge),k(de,{name:"fade"},{default:C(()=>[p.value[r]?(o(),l("div",Je,[k(d,{to:{name:"calendar-day",query:{date:n.day}}},{default:C(()=>[(o(!0),l(w,null,h(n.lessons,(s,_)=>(o(),l("div",{class:"day__content",key:s.id},[t("div",Ke,[t("div",Qe,[e[4]||(e[4]=t("div",{class:"day__lesson-circle"},null,-1)),t("p",null,i(s.start_time),1),e[5]||(e[5]=t("p",null,"-",-1)),t("p",null,i(s.end_time),1)]),t("div",Xe,i(s.student_name),1)]),s.breaks?(o(),l("div",Ye,[t("div",Ze,[e[7]||(e[7]=t("img",{src:we,class:"day-el",alt:""},null,-1)),e[8]||(e[8]=t("img",{src:he,class:"night-el",alt:""},null,-1)),t("div",et,[t("p",null,i(s.breaks.start_time),1),e[6]||(e[6]=t("p",null,"-",-1)),t("p",null,i(s.breaks.end_time),1)])]),e[9]||(e[9]=t("div",{class:"day__lesson-name"},"Перерыв",-1))])):u("",!0)]))),128))]),_:2},1032,["to"])])):u("",!0)]),_:2},1024)])):u("",!0)]))),128))])):u("",!0)])])):(o(),l("section",Se,[t("div",Me,[k(V,{"is-showed-break":!0,type:"week",onSetWeek:z,onPaginateWeek:Q,onToggleBreakMode:R}),!f.value&&c.value?(o(),l("div",Te,[c.value?(o(),l("table",Ce,[t("thead",null,[t("tr",Ee,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("th",{class:"calendar-header__item",key:r},i(Z(n.day)),1))),128))])]),t("tbody",null,[c.value&&c.value.week?(o(),l("tr",Le,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("td",{key:r,class:"calendar-row__item",onDragover:e[0]||(e[0]=oe(()=>{},["prevent"])),onDrop:s=>K(s,r)},[t("div",xe,[(o(!0),l(w,null,h(n.lessons,(s,_)=>(o(),l("div",{class:le(["calendar-card__content",{completed:s.completed}]),key:s.lesson_id,onClick:y=>q(s),draggable:"true",onDragstart:y=>J(y,s,r,_)},[t("div",{class:"calendar-card__lesson",style:re({height:Y(s.duration),gap:`${tt*s.duration}px`})},[t("p",null,i(O(s.start_time))+" - "+i(O(s.end_time)),1),t("p",null,i(s.student_name),1)],4),s.break&&s.break.duration?(o(),l("div",Be,i(s.break.duration),1)):u("",!0)],42,We))),128))])],40,Ie))),128))])):u("",!0)])])):u("",!0)])):u("",!0),f.value&&c.value?(o(),l("div",Oe,[$.value.length?(o(),se(P(De.DayPilotCalendar),{key:0,config:x.value,events:$.value,ref:"calendarRef"},{event:C(({event:n})=>[t("div",{class:"event",onClick:r=>q(n.data)},[t("div",qe,[t("div",ze,[t("div",Fe,[t("p",null,i(n.data.start_time)+" - "+i(n.data.end_time),1),t("p",null,i(n.data.student_name),1)]),n.data.break&&n.data.break.duration?(o(),l("div",Ne,i(n.data.break.duration),1)):u("",!0)])])],8,Re)]),_:1},8,["config","events"])):u("",!0)])):u("",!0),c.value?u("",!0):(o(),l("div",He,e[1]||(e[1]=[t("div",{class:"loader"},null,-1)])))])]))]),k(pe),k(be,{ref_key:"modalsContainer",ref:W},null,512)])}}};export{rt as default};
