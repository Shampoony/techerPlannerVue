import{r as m,u as ae,o as se,a as l,b as k,d as t,e as V,F as w,f as h,g as u,m as ne,w as M,l as oe,i as o,t as i,j as le,n as P,p as re,T as de,k as ie,h as ce}from"./index-Dam2ONG8.js";import{c as E,d as _e,f as ue,_ as me,a as ve,b as ke,v as ye,t as pe}from"./v-header-xsAYKBHm.js";import{u as fe,_ as U,a as ge,b as we,c as he}from"./v-modals-container-Mra4Yiks.js";import{d as be}from"./daypilot-vue.min-Ca2365T4.js";const De={class:"wrapper"},$e={key:0,class:"v-calendar-week"},Se={class:"v-calendar-week__container container"},Te={key:0,class:"v-calendar-week__content scroll-container"},Ce={key:0,class:"v-calendar-week__table calendar"},Me={class:"calendar-header"},Ee={key:0,class:"calendar-row"},Le=["onDrop"],Ie={class:"calendar-row__item-content calendar-card"},We=["onClick","onDragstart"],xe={key:0,class:"calendar-card__break"},Be={key:1,class:"v-calendar-week__break scroll-container"},Oe=["onClick"],Re={class:"event-header"},qe={class:"calendar-card__lesson"},ze={key:0,class:"calendar-card__break"},Fe={key:2,class:"loader-container"},Ne={key:1,class:"v-calendar-week-mob mob-page"},He={class:"v-calendar-week-mob__container container"},Ve={key:0,class:"v-calendar-week-mob__list"},Pe={key:0,class:"day"},Ue=["onClick"],je={class:"day__date"},Ge={key:0},Ae={class:"day__lesson"},Je={class:"day__lesson-time"},Ke={class:"day__lesson-name"},Qe={key:0,class:"day__lesson break"},Xe={class:"day__lesson-block"},Ye={class:"day__lesson-time"},Ze=10,j=90,ot={__name:"v-calendar-week",setup(et){const{isMobile:G}=fe(),p=m({}),A=ie(),L=oe(),f=m(localStorage.getItem("breakMode")==="true"),$=m();m(new Date);const I=m(L.query.start_date||"01.12.2025"),W=m({viewType:"Week",startDate:E(I.value),allowEventOverlap:!1,eventResizeHandling:"Disabled",timeRangeSelectedHandling:"Disabled",locale:"ru-RU",headerDateFormat:"ddd, d",touch:!0,weekStarts:1,onEventMoved:a=>{console.log("Event moved",a);const e=a.newStart.value,d=a.newStart.value,r=new Date(e).getDay(),s={start_time:e,end_time:d,day_of_week:r-1},_=a.e.data.lesson_id;console.log(s,_)},onEventResized:a=>{console.log("Event resized")}}),J=async a=>{const e=[];if(a)for(let d in a.week.days)a.week.days[d].lessons.forEach(n=>{const{start_time:r,end_time:s,..._}=n,y=`${a.week.days[d].day} ${r}`.replace(/(\d{2})\.(\d{2})\.(\d{4})/,"$3-$2-$1T").replace(" ",""),C=`${a.week.days[d].day} ${s}`.replace(/(\d{2})\.(\d{2})\.(\d{4})/,"$3-$2-$1T").replace(" ","");e.push({start:y,end:C,start_time:s.slice(0,5),end_time:s.slice(0,5),..._})});console.log(e),$.value=e},S=m({0:{day_of_week:"пн",date:""},1:{day_of_week:"вт",date:""},2:{day_of_week:"ср",date:""},3:{day_of_week:"чт",date:""},4:{day_of_week:"пт",date:""},5:{day_of_week:"сб",date:""},6:{day_of_week:"вс",date:""}}),x=ae("modalsContainer"),c=m(),B=m({}),T=m({lesson:null,fromColumnIndex:null,fromLessonIndex:null}),K=(a,e,d,n)=>{T.value={lesson:e,fromColumnIndex:d,fromLessonIndex:n}},O=a=>a.slice(0,5),Q=(a,e)=>{const{lesson:d,fromColumnIndex:n,fromLessonIndex:r}=T.value;if(n!==e){const s=c.value.week.days[n].lessons,_=c.value.week.days[e].lessons,y=S.value[e].date.toISOString().split("T")[0],C={day_of_week_id:parseInt(e),start_time:d.start_time,end_time:d.end_time,conducted_date:y},g=v=>{const[D,H]=v.split(":").map(Number);return D*60+H},F=g(d.start_time),te=g(d.end_time);for(let v of _){const D=g(v.start_time);if(!(g(v.end_time)<=F||D>=te)){alert("В этот день уже есть занятие на данное время");return}}let N=_.length;for(let v=0;v<_.length;v++)if(g(_[v].start_time)>F){N=v;break}s.splice(r,1),_.splice(N,0,d),pe(d.lesson_id,C).then(()=>{console.log("Перенос осуществлен")})}T.value={lesson:null,fromColumnIndex:null,fromLessonIndex:null}},R=()=>{f.value=!f.value,localStorage.setItem("breakMode",f.value),b()},X=()=>{b()},Y=a=>{if(!(a in p.value)){p.value[a]=!0;return}p.value[a]=!p.value[a]},q=a=>{x.value.toggleLessonModals("buttons",a)},Z=a=>Math.max(j,j*a),z=a=>{A.push({query:{start_date:a}}).then(()=>{b()})},ee=a=>{const[e,d,n]=a.split(".").map(Number);let r=new Date(n,d-1,e);return r=r.getDay()||7,S.value[r-1].date=new Date(n,d-1,e),`${S.value[r-1].day_of_week}, ${e}`},b=()=>{const a=L.query;if("start_date"in a)I.value=E(a.start_date),W.value.startDate=E(a.start_date),_e(a.start_date).then(e=>{console.log("Загружаем"),J(e),B.value=e,c.value=e});else{const e=new Date;window.location.search=`?start_date=${ue(e)}`}console.log(B.value)};return se(()=>{b()}),(a,e)=>{const d=ce("router-link");return o(),l("div",De,[k(me),t("main",null,[V(G)?(o(),l("section",Ne,[t("div",He,[k(U,{"is-showed-break":!0,type:"week",onSetWeek:z,onToggleBreakMode:R}),c.value&&c.value.week?(o(),l("ul",Ve,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("li",{key:r,class:"v-calendar-week-mob__list-item"},[n?(o(),l("div",Pe,[t("div",{class:"day__header",onClick:s=>Y(r)},[t("p",je,i(n.day),1),e[2]||(e[2]=t("img",{src:ve,class:"day-el",alt:""},null,-1)),e[3]||(e[3]=t("img",{src:ke,class:"night-el",alt:""},null,-1))],8,Ue),k(de,{name:"fade"},{default:M(()=>[p.value[r]?(o(),l("div",Ge,[k(d,{to:{name:"calendar-day",query:{date:n.day}}},{default:M(()=>[(o(!0),l(w,null,h(n.lessons,(s,_)=>(o(),l("div",{class:"day__content",key:s.id},[t("div",Ae,[t("div",Je,[e[4]||(e[4]=t("div",{class:"day__lesson-circle"},null,-1)),t("p",null,i(s.start_time),1),e[5]||(e[5]=t("p",null,"-",-1)),t("p",null,i(s.end_time),1)]),t("div",Ke,i(s.student_name),1)]),s.breaks?(o(),l("div",Qe,[t("div",Xe,[e[7]||(e[7]=t("img",{src:ge,class:"day-el",alt:""},null,-1)),e[8]||(e[8]=t("img",{src:we,class:"night-el",alt:""},null,-1)),t("div",Ye,[t("p",null,i(s.breaks.start_time),1),e[6]||(e[6]=t("p",null,"-",-1)),t("p",null,i(s.breaks.end_time),1)])]),e[9]||(e[9]=t("div",{class:"day__lesson-name"},"Перерыв",-1))])):u("",!0)]))),128))]),_:2},1032,["to"])])):u("",!0)]),_:2},1024)])):u("",!0)]))),128))])):u("",!0)])])):(o(),l("section",$e,[t("div",Se,[k(U,{"is-showed-break":!0,type:"week",onSetWeek:z,onPaginateWeek:X,onToggleBreakMode:R}),!f.value&&c.value?(o(),l("div",Te,[c.value?(o(),l("table",Ce,[t("thead",null,[t("tr",Me,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("th",{class:"calendar-header__item",key:r},i(ee(n.day)),1))),128))])]),t("tbody",null,[c.value&&c.value.week?(o(),l("tr",Ee,[(o(!0),l(w,null,h(c.value.week.days,(n,r)=>(o(),l("td",{key:r,class:"calendar-row__item",onDragover:e[0]||(e[0]=le(()=>{},["prevent"])),onDrop:s=>Q(s,r)},[t("div",Ie,[(o(!0),l(w,null,h(n.lessons,(s,_)=>(o(),l("div",{class:P(["calendar-card__content",{completed:s.completed}]),key:s.lesson_id,onClick:y=>q(s),draggable:"true",onDragstart:y=>K(y,s,r,_)},[t("div",{class:"calendar-card__lesson",style:re({height:Z(s.duration),gap:`${Ze*s.duration}px`})},[t("p",null,i(O(s.start_time))+" - "+i(O(s.end_time)),1),t("p",null,i(s.student_name),1)],4),s.break&&s.break.duration?(o(),l("div",xe,i(s.break.duration),1)):u("",!0)],42,We))),128))])],40,Le))),128))])):u("",!0)])])):u("",!0)])):u("",!0),f.value&&c.value?(o(),l("div",Be,[$.value.length?(o(),ne(V(be.DayPilotCalendar),{key:0,config:W.value,events:$.value,ref:"calendarRef"},{event:M(({event:n})=>[t("div",{class:"event",onClick:r=>q(n.data)},[t("div",Re,[t("div",{class:P(["calendar-card__content",{completed:a.lesson.completed}])},[t("div",qe,[t("p",null,i(n.data.start_time)+" - "+i(n.data.end_time),1),t("p",null,i(n.data.student_name),1)]),n.data.break&&n.data.break.duration?(o(),l("div",ze,i(n.data.break.duration),1)):u("",!0)],2)])],8,Oe)]),_:1},8,["config","events"])):u("",!0)])):u("",!0),c.value?u("",!0):(o(),l("div",Fe,e[1]||(e[1]=[t("div",{class:"loader"},null,-1)])))])]))]),k(ye),k(he,{ref_key:"modalsContainer",ref:x},null,512)])}}};export{ot as default};
